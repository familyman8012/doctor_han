# 통합 메시징 시스템 PRD

> 참조: `app/src/server/notification/service.ts:1`, `app/src/lib/schema/notification.ts:1`
> 본 문서는 현재 이메일 발송 시스템과 사용자 요구사항을 기반으로 카카오 알림톡 병렬 발송 기능을 정의한다.

## 1. 배경 및 문제 정의

현재 Medihub는 Resend를 통한 이메일 알림만 지원한다. 그러나 이메일 확인율은 낮고, 사용자들은 즉각적인 알림 수신을 원한다. 특히 인증 승인/반려, 리드 알림은 시의성이 중요한 정보로, 카카오 알림톡을 통한 빠른 전달이 필요하다.

- `notification_channel` enum에 'kakao', 'sms'가 이미 정의되어 있으나 실제 발송 기능은 미구현 상태다 (탐색: exploration.md:85)
- 환경변수 `SOLAPI_API_KEY`, `SOLAPI_API_SECRET`, `SOLAPI_SENDER_PHONE`, `SOLAPI_KAKAO_PFID`가 준비되어 있으나 주석 처리된 상태다 (탐색: exploration.md:89)
- 리드 생성/응답 시 알림 발송이 구현되어 있지 않아 업체가 리드를 놓치는 경우가 발생한다 (탐색: exploration.md:98)

## 2. 목표 (Goals)

1. Solapi 연동으로 카카오 알림톡 발송 기능을 추가한다
2. 발송 실패 시 최대 3회 즉시 재시도 (exponential backoff)를 구현한다
3. 사용자가 이메일/카카오 각각 ON/OFF 설정할 수 있도록 한다
4. 인증 승인/반려 시 카카오 알림톡을 병렬 발송한다
5. 리드 생성/응답 시 카카오 알림톡을 발송하여 사용자 경험을 향상시킨다

## 3. 비범위 (Non-Goals)

- 별도 큐 시스템 (cron/스케줄러) 구현: 즉시 재시도 방식으로 충분히 처리 가능
- 마케팅 알림톡: 사전 동의 및 별도 템플릿이 필요하므로 후속 단계로 미룸
- SMS fallback: 카카오 실패 시 SMS로 전환하는 기능은 복잡도 대비 효용이 낮아 제외

## 4. 주요 사용자 및 시나리오

| 사용자 | 시나리오 | 기대 결과 |
|--------|----------|-----------|
| 의사 | 본인인증 제출 후 승인/반려 결과 대기 | 카카오 알림톡으로 즉시 결과 수신 |
| 업체 | 리드 생성됨 | 카카오 알림톡으로 새 리드 알림 수신 |
| 의사 | 업체가 리드에 응답함 | 카카오 알림톡으로 응답 알림 수신 |
| 사용자 | 알림 설정 페이지 접근 | 이메일/카카오 각각 ON/OFF 토글 가능 |

## 5. 기능 요구사항

### 5.1 카카오 알림톡 발송

- Solapi SDK를 통해 카카오 알림톡을 발송한다
  - 근거: 환경변수 이미 준비됨 (exploration.md:89)
- 알림톡 템플릿 종류:
  - 인증 승인 완료
  - 인증 반려 (사유 포함)
  - 새 리드 접수 (업체용)
  - 리드 응답 도착 (의사용)
- 발송 결과는 `notification_deliveries` 테이블에 기록한다
  - 근거: 기존 이메일 발송 패턴 참조 (exploration.md:127-149)

### 5.2 병렬 발송 및 재시도

- 이메일과 카카오를 병렬로 발송한다 (`Promise.allSettled`)
- 각 채널은 독립적으로 발송/재시도된다 (한 채널 실패가 다른 채널에 영향 없음)
- 발송 실패 시 즉시 재시도한다:
  - 최대 3회 재시도
  - Exponential backoff: 2초, 4초, 8초
- 재시도 정보는 `notification_deliveries` 테이블에 기록한다:
  - `retry_count`: 현재 재시도 횟수
  - `max_retries`: 최대 재시도 횟수 (기본값 3)
  - `status`: pending, sent, failed

### 5.3 사용자 알림 설정

- `notification_settings` 테이블에 `kakao_enabled` 컬럼을 추가한다
- 기본값: `false` (옵트인 방식)
- 사용자는 마이페이지에서 이메일/카카오를 각각 ON/OFF 설정할 수 있다
  - 근거: 기존 토글 UI 패턴 참조 (exploration.md:156-170)

### 5.4 알림 발송 시나리오

**인증 결과 알림**:
- 승인 시: 이메일 + 카카오 병렬 발송
- 반려 시: 이메일 + 카카오 병렬 발송 (반려 사유 포함)
  - 근거: 기존 승인/반려 API 참조 (exploration.md:29-30)

**리드 알림**:
- 리드 생성 시: 업체에 카카오 알림톡 발송
- 리드 응답 시: 의사에 카카오 알림톡 발송
  - 근거: 현재 미구현 (exploration.md:31, 98)

### 5.5 UI 진입점 (상세 설계는 TSD)

- **경로**: `/mypage/notifications`, `/partner/notifications`
- **진입점**: 마이페이지 > 알림 설정
- **주요 화면**: 기존 이메일 토글 하단에 카카오 알림톡 토글 추가
- **레퍼런스**: 기존 알림 설정 페이지 (exploration.md:20-21)

### 5.6 API / 데이터

- `GET /api/notification-settings` - kakao_enabled 필드 추가
- `PATCH /api/notification-settings` - kakao_enabled 업데이트 지원
- 기존 API 확장, 신규 API 없음

### 5.7 권한/보안

- 권한 변경 없음
- 기존 RLS 정책 유지 (사용자 본인의 설정만 조회/수정 가능)
- 알림 발송 시 Admin 클라이언트 사용하여 RLS 우회
  - 근거: 기존 패턴 참조 (exploration.md:114)

## 6. 비기능 요구사항 (NFR)

- 성능/응답성:
  - API p95 응답 시간 목표: 500ms 이내 (측정: 서버 로그)
  - 알림 발송은 비동기 처리 (메인 로직 블로킹 없음)
  - 데이터 규모 가정: 일일 알림 발송 1,000건 이하

- 안정성/복구:
  - Solapi 타임아웃: 10초
  - 재시도: 최대 3회, exponential backoff (2초, 4초, 8초)
  - 부분 실패 처리: 이메일/카카오 독립 발송, 한 채널 실패가 다른 채널에 영향 없음
  - 멱등성: 동일 알림 중복 발송 방지 (notification_deliveries 조회 후 발송)

- 관측(로그/감사/지표):
  - 발송 로그: notification_deliveries 테이블에 기록
  - 로그 키: userId, notificationType, channel, status, retryCount
  - 실패 분석: errorMessage 컬럼에 상세 에러 저장

## 7. 엣지 케이스

- 사용자 휴대폰 번호 미등록: 카카오 알림톡 발송 스킵 (이메일만 발송)
- 두 채널 모두 OFF: 알림 발송 스킵 (의도적, 로그 기록 없음)
- Solapi 장애: 재시도 후 실패 로그 기록, 이메일은 정상 발송
- 동시 요청: notification_deliveries에 UNIQUE 제약으로 중복 방지

## 8. 리스크 및 대응

| 리스크 | 영향 | 대응 |
|--------|------|------|
| Solapi 장애 | 카카오 알림 미발송 | 재시도 로직 + 이메일 fallback (이메일은 정상 발송) |
| 알림톡 템플릿 미승인 | 발송 불가 | 사전에 템플릿 승인 필요, 검수 기간 고려 |
| 재시도로 인한 지연 | 최대 14초 추가 지연 | 비동기 처리로 사용자 응답 지연 없음 |

## 9. 롤아웃 / 백로그

1. 1차 릴리스 범위:
   - Solapi SDK 연동
   - kakao_enabled 컬럼 및 UI 토글
   - 인증 결과 알림톡 발송
   - 재시도 로직

2. 후속 백로그 항목:
   - [ ] 리드 알림톡 발송 (2차)
   - [ ] 알림 발송 대시보드 (어드민)
   - [ ] SMS fallback (필요시)

## 10. 오픈 이슈 / 결정 필요

- [ ] (선택) 카카오 알림톡 템플릿 ID 확정 필요 (Solapi 콘솔에서 생성)
- [ ] (선택) 리드 알림 발송 시점: 리드 생성 즉시 vs 일정 시간 후 (묶음 발송)
