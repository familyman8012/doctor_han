# 리드 Q&A 스레드 PRD

> 참조: `app/src/server/lead/repository.ts:1`, `app/src/lib/schema/lead.ts:1`
> 본 문서는 기존 리드 시스템과 통합 메시징 서비스를 기반으로 리드 Q&A 스레드 기능을 정의한다.

## 1. 배경 및 문제 정의

현재 리드 시스템에서 의사와 업체 간 커뮤니케이션은 외부 채널(전화, 카카오톡, 이메일 등)에 의존하고 있다. 이로 인해 다음 문제가 발생한다:

- 리드 문의에 대한 소통 이력이 플랫폼 외부에 분산되어 추적 불가
- 업체 응대 품질 모니터링 및 분쟁 해결 시 근거 자료 확보 어려움
- 의사-업체 간 연락처 노출로 인한 개인정보 관리 부담

기존 리드 시스템은 문의 생성과 상태 변경만 지원하며, 참여자 간 메시지 교환 기능이 없다. (근거: `app/src/app/api/leads/` - 메시지 관련 API 부재)

## 2. 목표 (Goals)

1. 의사-업체 간 메시지 송수신 기능 제공 (관리자는 열람만)
2. 메시지별 읽음 시간 표시로 소통 상태 가시화
3. 메시지별 첨부파일 지원 (최대 5개)으로 상세 자료 공유 가능
4. 기존 리드 상세 페이지에 대화 탭/섹션 추가로 자연스러운 UX 연결
5. 새 메시지 알림 (Email + 카카오 알림톡)으로 적시 응대 유도

## 3. 비범위 (Non-Goals)

- 리드 상태 자동화 (타임아웃/리마인드) - 후속 단계로 미룸
- 종료 사유 수집 - 후속 단계로 미룸
- 관리자 대화 참여 (열람만 가능)
- 실시간 웹소켓 (폴링/리프레시 기반으로 구현)
- 메시지 수정/삭제 기능

## 4. 주요 사용자 및 시나리오

| 사용자 | 시나리오 | 기대 결과 |
|--------|----------|-----------|
| 의사 | 문의한 리드에 대해 업체에 추가 질문을 남긴다 | 메시지가 전송되고 업체에게 알림이 발송된다 |
| 의사 | 업체의 답변을 확인하고 첨부파일을 다운로드한다 | 메시지 읽음 표시가 업데이트되고 파일을 다운로드할 수 있다 |
| 업체 | 의사의 문의에 견적서 파일을 첨부하여 답변한다 | 메시지와 첨부파일이 전송되고 의사에게 알림이 발송된다 |
| 업체 | 새 메시지 알림을 받고 대화 내역을 확인한다 | 알림을 통해 리드 상세 페이지로 이동하여 메시지를 확인한다 |
| 관리자 | 분쟁 상황에서 의사-업체 간 대화 내역을 확인한다 | 대화 전체 내역을 열람하여 상황을 파악할 수 있다 |

## 5. 기능 요구사항

### 5.1 메시지 송수신

- 의사와 업체 담당자만 메시지를 작성할 수 있다
  - 근거: 기존 RLS 패턴 `is_vendor_owner(l.vendor_id)` 참조
- 관리자는 메시지 열람만 가능하며 작성 권한 없음
- 메시지 내용은 필수이며, 빈 문자열 불가
- 메시지는 삭제/수정 불가 (감사 추적성 보장)

### 5.2 읽음 표시

- 메시지별 `read_at` 타임스탬프로 읽음 상태 관리
- 수신자만 읽음 표시 업데이트 가능
- 발신자는 자신이 보낸 메시지의 읽음 상태 확인 가능
- 읽지 않은 메시지는 UI에서 구분하여 표시

### 5.3 첨부파일

- 메시지별 최대 5개 파일 첨부 가능
- 기존 `files` 테이블 및 `lead_attachment` 패턴 재사용
- 신규 `file_purpose`: `lead_message_attachment`
- 파일 다운로드는 기존 `/api/files/signed-download` API 활용

### 5.4 알림

- 새 메시지 수신 시 Email + 카카오 알림톡 발송
- 기존 통합 메시징 서비스 활용
  - 근거: `app/src/server/notification/service.ts` 참조
- 신규 `notification_type`: `lead_message_received`
- 사용자별 알림 설정(`notification_settings`) 존중

### 5.5 UI 진입점

- **경로**:
  - 의사: `/mypage/leads/[id]`
  - 업체: `/partner/leads/[id]`
- **진입점**: 기존 리드 상세 페이지에 "대화" 탭/섹션 추가
- **주요 화면**: 메시지 목록 + 메시지 입력 + 첨부파일 업로드
- **레퍼런스**: 기존 리드 상세 페이지 구조
  - `app/src/app/(main)/mypage/leads/[id]/page.tsx`
  - `app/src/app/(main)/partner/leads/[id]/page.tsx`

### 5.6 API / 데이터

- 필요한 API 엔드포인트:
  - `GET /api/leads/[id]/messages` - 메시지 목록 조회 (페이지네이션)
  - `POST /api/leads/[id]/messages` - 메시지 발송 (첨부파일 포함)
  - `PATCH /api/leads/[id]/messages/read` - 읽음 표시 (bulk)
- 신규 테이블:
  - `lead_messages` - 메시지 저장
  - `lead_message_attachments` - 메시지 첨부파일 연결

### 5.7 권한/보안

- 메시지 조회: 리드 참여자(의사, 업체 담당자) + 관리자
- 메시지 작성: 리드 참여자(의사, 업체 담당자)만 가능, 관리자 불가
- 읽음 표시: 수신자만 업데이트 가능 (발신자 제외)
- RLS 정책:
  - SELECT: `is_admin()` OR 참여자 조건
  - INSERT: 참여자 조건 AND `sender_id = auth.uid()`
  - UPDATE: `sender_id != auth.uid()` (읽음 표시만 허용)

## 6. 비기능 요구사항 (NFR)

- 성능/응답성:
  - (API) 메시지 목록 조회 p95 응답 시간: 200ms 이하
  - (목록) 페이지네이션: `page`, `pageSize` (기본 20, 최대 50)
  - (목록) 정렬: `created_at` ASC (오래된 메시지부터)
  - (프론트) 로딩 시 스피너/스켈레톤 표시
  - (데이터 규모) 리드당 예상 메시지 수: 10~50개 (최대 1000개 가정)
- 안정성/복구:
  - 알림 발송 실패 시 기존 재시도 로직 활용 (Exponential backoff, 최대 3회)
  - 메시지 발송은 DB 저장 후 알림 발송 (알림 실패해도 메시지는 저장됨)
- 관측:
  - 메시지 발송 로그: `lead_id`, `sender_id`, `message_id`
  - 알림 발송 로그: 기존 `notification_deliveries` 테이블 활용

## 7. 엣지 케이스

- 동시에 양측이 메시지를 보내는 경우: 각각 저장되고 시간순 정렬
- 첨부파일 업로드 중 메시지 발송 시: 업로드 완료 후 메시지 발송
- 리드가 closed/canceled 상태여도 대화 열람 가능 (작성 여부는 TSD에서 결정)
- 업체 담당자 변경 시: 새 담당자도 기존 대화 열람 가능 (`is_vendor_owner` 기반)

## 8. 리스크 및 대응

| 리스크 | 영향 | 대응 |
|--------|------|------|
| 스팸/도배 메시지 | UX 저하, 서버 부하 | Rate limiting 적용 (분당 10건) |
| 대용량 첨부파일 | 저장소 비용 증가, 업로드 지연 | 기존 파일 업로드 제한 정책 준수 |
| 알림 폭주 | 사용자 피로도 증가 | 동일 리드 내 짧은 시간 내 다중 알림 병합 고려 (후속) |

## 9. 롤아웃 / 백로그

1. 1차 릴리스 범위
   - 메시지 송수신 기본 기능
   - 읽음 표시
   - 첨부파일 지원
   - Email + 카카오 알림

2. 후속 백로그 항목
   - [ ] 리드 상태 자동화 (응답 타임아웃, 리마인드)
   - [ ] 종료 사유 수집
   - [ ] 알림 병합 (동일 리드 내 다중 메시지)
   - [ ] 메시지 검색 기능

## 10. 오픈 이슈 / 결정 필요

- [ ] (선택) closed/canceled 상태 리드에서 메시지 작성 허용 여부 - TSD에서 결정
- [ ] (선택) Rate limiting 구체적 수치 확정 - 분당 10건 제안
