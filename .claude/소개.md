# Medihub (doctor_han) - Claude Pack 소개

이 문서는 Medihub 레포에 설정된 Claude Pack(`.agents/`, `.claude/`)의 구성 요소와 운영 방법을 설명합니다.

---

## 목차

1. [개요](#개요)
2. [폴더 구조](#폴더-구조)
3. [CLAUDE.md (전역 규칙)](#claudemd-전역-규칙)
4. [Commands (명령어)](#commands-명령어)
5. [Agents (에이전트)](#agents-에이전트)
6. [Skills (스킬)](#skills-스킬)
7. [Reference (참조 문서)](#reference-참조-문서)
8. [Plan Templates (계획 템플릿)](#plan-templates-계획-템플릿)
9. [권장 워크플로우 예시](#권장-워크플로우-예시)

---

## 개요

이 설정의 목표는 다음 3가지를 동시에 달성하는 것입니다.

1. **컨텍스트 오염 최소화**: 긴 작업에서도 “정확성”을 유지
2. **드리프트 방지**: 레포가 변해도 문서/가이드가 낡지 않게 유지
3. **반복 작업 표준화**: PRD→계획→구현→검증 루프를 커맨드/에이전트로 고정

### 핵심 원칙

| # | 원칙 | 설명 |
|---|------|------|
| 1 | **PRD 우선** | 구현은 요구사항(북극성)에서만 시작 |
| 2 | **2-layer 컨텍스트** | 수동 문서(정책) + 생성 문서(팩트/인덱스) |
| 3 | **명령어화** | 반복 절차를 커맨드로 고정해 품질/속도 향상 |
| 4 | **컨텍스트 리셋** | 계획과 실행을 분리해 실수를 줄임 |
| 5 | **Fail-fast** | 정책 위반/스펙 결함은 즉시 중단/보강 |

### PIV 루프 (Prime-Implement-Validate)

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────────┐
│  Prime  │ → │  Plan   │ → │ Execute │ → │ Validate  │
└─────────┘    └─────────┘    └─────────┘    └──────────┘
컨텍스트 로드   기능 계획      계획 실행      전체 검증
```

간편 실행(권장): `/workflow <domain/feature>`

---

## 폴더 구조

```
doctor_han/
├── CLAUDE.md                          # 프로젝트 전역 규칙 (루트)
├── app/                               # Next.js 앱(여기서 pnpm 실행)
│   ├── src/
│   ├── supabase/
│   │   └── migrations/                # SQL 마이그레이션
│   └── doc/
│       └── domains/                   # 도메인 PRD
├── .claude/
│   ├── README.md                      # Manual/Generated 요약
│   ├── PRD.md                         # 제품 요구사항(요약/인덱스)
│   ├── 소개.md                        # 이 문서
│   ├── settings.local.json            # 로컬 권한/훅
│   ├── scripts/
│   │   └── refresh.py                 # _generated 갱신 스크립트
│   ├── hooks/
│   │   ├── pre-migration-guard.sh     # 기존 마이그레이션 수정 차단
│   │   └── post-lint-fix.sh           # 수정 후 ESLint fix(가능한 범위)
│   ├── commands/
│   ├── agents/
│   ├── skills/
│   └── reference/
│       ├── _generated/                # (자동) 레포 상태 기반 팩트/인덱스
│       └── ...                        # (수동) 패턴/템플릿
└── .agents/
    └── plans/
        └── templates/                 # plan 템플릿
```

---

## CLAUDE.md (전역 규칙)

`CLAUDE.md`는 Medihub의 “정책(Policy)”을 담는 최상위 문서입니다.

특히 다음 규칙은 **위반 시 즉시 수정** 대상입니다.

- 브라우저에서 Supabase(DB) 직접 호출 금지(예외: Auth/Storage)
- Server Action 금지
- React Query 커스텀 훅 래핑 금지(컴포넌트에서 직접 사용)
- 분산 `onError` 금지(중앙 에러 핸들러 사용)

---

## Commands (명령어)

Custom Commands는 반복적인 작업을 표준화된 프롬프트로 자동화합니다.

### core_piv_loop/

| 명령어 | 설명 |
|--------|------|
| `/workflow` | 전체 워크플로우(Prime→Plan→Execute→Validate→Review) |
| `/refresh` | 생성 문서(팩트/인덱스) 갱신 |
| `/prime` | 컨텍스트 로드(문서/코드/유사 패턴) |
| `/plan-feature` | 기능 계획 생성(.agents/plans) |
| `/execute` | 계획 파일 기반 실행 |

### docs/

| 명령어 | 설명 |
|--------|------|
| `/new-prd` | PRD 스켈레톤 생성 |
| `/new-tsd` | TSD 스켈레톤 생성(필요 시) |

### db/

| 명령어 | 설명 |
|--------|------|
| `/new-migration` | Supabase SQL 마이그레이션 생성 |
| `/gen-types` | Supabase 타입 생성(database.types.ts) |

### domain/

| 명령어 | 설명 |
|--------|------|
| `/new-api` | BFF API 엔드포인트 스캐폴딩 |

### validation/

| 명령어 | 설명 |
|--------|------|
| `/validate` | lint → type-check → test → build |
| `/code-review` | 정책/패턴 준수 중심 코드 리뷰 |

---

## Agents (에이전트)

| 에이전트 | 역할 | 제한 |
|----------|------|------|
| `@planner` | 계획 수립 | 코드 작성 금지 |
| `@explorer` | 코드 탐색 | 읽기 전용 |
| `@reviewer` | 코드 리뷰 | 읽기 전용 |
| `@spec-writer` | PRD/TSD/UI 작성 | 코드 작성 금지 |

---

## Skills (스킬)

스킬은 “반복 작업 단위”를 문서화한 가이드입니다.

| 스킬 | 목적 |
|------|------|
| `api-generator` | withApi/guards/Zod/ok-fail 기반 API Route 생성 |
| `db-migration` | Supabase SQL 마이그레이션(+RLS) 작성 |
| `zod-schema` | Zod 계약(Query/Body/Response) 작성 |
| `service-layer` | server 도메인 모듈(repository/mapper/service) 구성 |

---

## Reference (참조 문서)

### 정책/패턴

- `.claude/reference/coding-conventions.md`
- `.claude/reference/nextjs-patterns.md`
- `.claude/reference/supabase-patterns.md`
- `.claude/reference/frontend-patterns.md`
- `.claude/reference/api-patterns.md`
- `.claude/reference/service-patterns.md`
- `.claude/reference/zod-patterns.md`

### 템플릿

- `.claude/reference/spec-templates.md`
- `.claude/reference/api-route-templates.md`
- `.claude/reference/db-migration-templates.md`
- `.claude/reference/zod-schema-templates.md`
- `.claude/reference/service-layer-templates.md`

### 생성 문서(자동)

- `.claude/reference/_generated/project-facts.md`
- `.claude/reference/_generated/api-routes-index.md`
- `.claude/reference/_generated/domain-specs-index.md`
- `.claude/reference/_generated/migrations-index.md`

---

## Plan Templates (계획 템플릿)

- `.agents/plans/templates/feature-plan.md`
- `.agents/plans/templates/bugfix-plan.md`

---

## 권장 워크플로우 예시

### 1) 기능 추가(권장 루프)

1. `/refresh`
2. `/prime vendor/search`
3. PRD/TSD가 없거나 DoR 실패면 → `@spec-writer`
4. `/plan-feature vendor/search` → `.agents/plans/vendor__search.md`
5. (컨텍스트 리셋) `/execute vendor__search`
6. `/validate` → `/code-review`

### 2) DB 변경이 포함된 경우(추가 규칙)

- 새 마이그레이션: `cd app && pnpm db:new -- "<name>"`
- 기존 마이그레이션 수정 금지(정정은 새 마이그레이션)
- 적용/타입:
  - `cd app && pnpm db:migrate`
  - `cd app && pnpm db:gen -- --local`

